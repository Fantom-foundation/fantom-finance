{"version":3,"sources":["../../src/commands/serve.js"],"names":["path","require","openurl","fs","compression","express","chalk","match","reachMatch","onExit","report","telemetry","detectPortInUseAndPrompt","getConfigFile","preferDefault","trackCli","readMatchPaths","program","filePath","join","directory","rawJSON","readFile","error","warn","bold","JSON","parse","matchPathRouter","matchPaths","options","req","res","next","url","accepts","matchPath","find","sendFile","err","module","exports","startBackgroundUpdate","prefixPaths","port","open","host","parseInt","configModule","config","pathPrefix","configPathPrefix","root","app","router","Router","use","expressMiddleware","static","status","header","startListening","listen","openUrlString","info","Promise","resolve","catch","e","message"],"mappings":"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","sourcesContent":["/* @flow weak */\nconst path = require(`path`)\nconst openurl = require(`better-opn`)\nconst fs = require(`fs-extra`)\nconst compression = require(`compression`)\nconst express = require(`express`)\nconst chalk = require(`chalk`)\nconst { match: reachMatch } = require(`@reach/router/lib/utils`)\nconst onExit = require(`signal-exit`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\nconst telemetry = require(`gatsby-telemetry`)\n\nconst detectPortInUseAndPrompt = require(`../utils/detect-port-in-use-and-prompt`)\nconst getConfigFile = require(`../bootstrap/get-config-file`)\nconst preferDefault = require(`../bootstrap/prefer-default`)\n\nonExit(() => {\n  telemetry.trackCli(`SERVE_STOP`)\n})\n\nconst readMatchPaths = async program => {\n  const filePath = path.join(program.directory, `.cache`, `match-paths.json`)\n  let rawJSON = `[]`\n  try {\n    rawJSON = await fs.readFile(filePath)\n  } catch (error) {\n    report.warn(error)\n    report.warn(\n      `Could not read ${chalk.bold(\n        `match-paths.json`\n      )} from the .cache directory`\n    )\n    report.warn(\n      `Client-side routing will not work correctly. Maybe you need to re-run ${chalk.bold(\n        `gatsby build`\n      )}?`\n    )\n  }\n  return JSON.parse(rawJSON)\n}\n\nconst matchPathRouter = (matchPaths, options) => (req, res, next) => {\n  const { url } = req\n  if (req.accepts(`html`)) {\n    const matchPath = matchPaths.find(\n      ({ matchPath }) => reachMatch(matchPath, url) !== null\n    )\n    if (matchPath) {\n      return res.sendFile(\n        path.join(matchPath.path, `index.html`),\n        options,\n        err => {\n          if (err) {\n            next()\n          }\n        }\n      )\n    }\n  }\n  return next()\n}\n\nmodule.exports = async program => {\n  telemetry.trackCli(`SERVE_START`)\n  telemetry.startBackgroundUpdate()\n  let { prefixPaths, port, open, host } = program\n  port = typeof port === `string` ? parseInt(port, 10) : port\n\n  const { configModule } = await getConfigFile(\n    program.directory,\n    `gatsby-config`\n  )\n  const config = preferDefault(configModule)\n\n  const { pathPrefix: configPathPrefix } = config || {}\n\n  const pathPrefix = prefixPaths && configPathPrefix ? configPathPrefix : `/`\n\n  const root = path.join(program.directory, `public`)\n\n  const app = express()\n  const router = express.Router()\n\n  app.use(telemetry.expressMiddleware(`SERVE`))\n\n  router.use(compression())\n  router.use(express.static(`public`))\n  const matchPaths = await readMatchPaths(program)\n  router.use(matchPathRouter(matchPaths, { root }))\n  router.use((req, res, next) => {\n    if (req.accepts(`html`)) {\n      return res.status(404).sendFile(`404.html`, { root })\n    }\n    return next()\n  })\n  app.use(function(req, res, next) {\n    res.header(`Access-Control-Allow-Origin`, `*`)\n    res.header(\n      `Access-Control-Allow-Headers`,\n      `Origin, X-Requested-With, Content-Type, Accept`\n    )\n    next()\n  })\n  app.use(pathPrefix, router)\n\n  const startListening = () => {\n    app.listen(port, host, () => {\n      let openUrlString = `http://${host}:${port}${pathPrefix}`\n      report.info(`gatsby serve running at: ${chalk.bold(openUrlString)}`)\n      if (open) {\n        report.info(`Opening browser...`)\n        Promise.resolve(openurl(openUrlString)).catch(err =>\n          report.warn(`Browser not opened because no browser was found`)\n        )\n      }\n    })\n  }\n\n  try {\n    port = await detectPortInUseAndPrompt(port)\n    startListening()\n  } catch (e) {\n    if (e.message === `USER_REJECTED`) {\n      return\n    }\n\n    throw e\n  }\n}\n"],"file":"serve.js"}