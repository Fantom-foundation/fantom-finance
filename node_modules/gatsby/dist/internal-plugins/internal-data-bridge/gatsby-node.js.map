{"version":3,"sources":["../../../src/internal-plugins/internal-data-bridge/gatsby-node.js"],"names":["moment","require","chokidar","systemPath","_","emitter","boundActionCreators","getNode","transformPackageJson","json","transformDeps","deps","entries","map","name","version","pick","dependencies","devDependencies","peerDependencies","optionalDependecies","bundledDependecies","createPageId","path","exports","sourceNodes","createContentDigest","actions","store","createNode","state","getState","program","flattenedPlugins","page","id","parent","children","internal","type","contentDigest","forEach","plugin","pluginFilepath","resolve","packageJson","buildTime","subtract","process","uptime","toJSON","createGatsbyConfigNode","config","configCopy","plugins","node","siteMetadata","port","host","pathToGatsbyConfig","join","directory","watch","on","oldCache","cache","e","undefined","onCreatePage","pageWithoutUpdated","description","pluginCreatorId","action","nodeId","payload","deleteNode"],"mappings":"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","sourcesContent":["const moment = require(`moment`)\nconst chokidar = require(`chokidar`)\nconst systemPath = require(`path`)\nconst _ = require(`lodash`)\n\nconst { emitter } = require(`../../redux`)\nconst { boundActionCreators } = require(`../../redux/actions`)\nconst { getNode } = require(`../../db/nodes`)\n\nfunction transformPackageJson(json) {\n  const transformDeps = deps =>\n    _.entries(deps).map(([name, version]) => {\n      return {\n        name,\n        version,\n      }\n    })\n\n  json = _.pick(json, [\n    `name`,\n    `description`,\n    `version`,\n    `main`,\n    `keywords`,\n    `author`,\n    `license`,\n    `dependencies`,\n    `devDependencies`,\n    `peerDependencies`,\n    `optionalDependecies`,\n    `bundledDependecies`,\n  ])\n  json.dependencies = transformDeps(json.dependencies)\n  json.devDependencies = transformDeps(json.devDependencies)\n  json.peerDependencies = transformDeps(json.peerDependencies)\n  json.optionalDependecies = transformDeps(json.optionalDependecies)\n  json.bundledDependecies = transformDeps(json.bundledDependecies)\n\n  return json\n}\n\nconst createPageId = path => `SitePage ${path}`\n\nexports.sourceNodes = ({ createContentDigest, actions, store }) => {\n  const { createNode } = actions\n  const state = store.getState()\n  const { program } = state\n  const { flattenedPlugins } = state\n\n  // Add our default development page since we know it's going to\n  // exist and we need a node to exist so its query works :-)\n  const page = { path: `/dev-404-page/` }\n  createNode({\n    ...page,\n    id: createPageId(page.path),\n    parent: null,\n    children: [],\n    internal: {\n      type: `SitePage`,\n      contentDigest: createContentDigest(page),\n    },\n  })\n\n  flattenedPlugins.forEach(plugin => {\n    plugin.pluginFilepath = plugin.resolve\n    createNode({\n      ...plugin,\n      packageJson: transformPackageJson(\n        require(`${plugin.resolve}/package.json`)\n      ),\n      parent: null,\n      children: [],\n      internal: {\n        contentDigest: createContentDigest(plugin),\n        type: `SitePlugin`,\n      },\n    })\n  })\n\n  // Add site node.\n  const buildTime = moment()\n    .subtract(process.uptime(), `seconds`)\n    .toJSON()\n\n  const createGatsbyConfigNode = (config = {}) => {\n    // Delete plugins from the config as we add plugins above.\n    const configCopy = { ...config }\n    delete configCopy.plugins\n    const node = {\n      siteMetadata: {\n        ...configCopy.siteMetadata,\n      },\n      port: state.program.port,\n      host: state.program.host,\n      ...configCopy,\n      buildTime,\n    }\n    createNode({\n      ...node,\n      id: `Site`,\n      parent: null,\n      children: [],\n      internal: {\n        contentDigest: createContentDigest(node),\n        type: `Site`,\n      },\n    })\n  }\n\n  createGatsbyConfigNode(state.config)\n\n  const pathToGatsbyConfig = systemPath.join(\n    program.directory,\n    `gatsby-config.js`\n  )\n  chokidar.watch(pathToGatsbyConfig).on(`change`, () => {\n    const oldCache = require.cache[require.resolve(pathToGatsbyConfig)]\n    try {\n      // Delete require cache so we can reload the module.\n      delete require.cache[require.resolve(pathToGatsbyConfig)]\n      const config = require(pathToGatsbyConfig)\n      createGatsbyConfigNode(config)\n    } catch (e) {\n      // Restore the old cache since requiring the new gatsby-config.js failed.\n      if (oldCache !== undefined) {\n        require.cache[require.resolve(pathToGatsbyConfig)] = oldCache\n      }\n    }\n  })\n}\n\nexports.onCreatePage = ({ createContentDigest, page, actions }) => {\n  const { createNode } = actions\n  // eslint-disable-next-line\n  const { updatedAt, ...pageWithoutUpdated } = page\n\n  // Add page.\n  createNode({\n    ...pageWithoutUpdated,\n    id: createPageId(page.path),\n    parent: null,\n    children: [],\n    internal: {\n      type: `SitePage`,\n      contentDigest: createContentDigest(pageWithoutUpdated),\n      description:\n        page.pluginCreatorId === `Plugin default-site-plugin`\n          ? `Your site's \"gatsby-node.js\"`\n          : page.pluginCreatorId,\n    },\n  })\n}\n\n// Listen for DELETE_PAGE and delete page nodes.\nemitter.on(`DELETE_PAGE`, action => {\n  const nodeId = createPageId(action.payload.path)\n  const node = getNode(nodeId)\n  boundActionCreators.deleteNode({ node })\n})\n"],"file":"gatsby-node.js"}